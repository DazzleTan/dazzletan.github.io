<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>矩阵球控制系统</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a3a, #2c3e50);
            color: var(--light-color);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-5px);
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--primary-color);
        }
        
        .visualization {
            height: 300px;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .matrix-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }
        
        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 20px;
            transform-style: preserve-3d;
            transform: rotateX(60deg) rotateZ(45deg);
        }
        
        .matrix-cell {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            box-shadow: 0 0 24px 8px var(--primary-color), 0 0 32px 4px var(--primary-color);
            transition: all 0.5s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            position: relative;
        }
        
        .matrix-cell.active {
            background: var(--success-color);
            box-shadow: 0 0 15px var(--success-color);
            transform: translateZ(20px);
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .value-display {
            text-align: center;
            font-size: 1.2rem;
            margin-top: 5px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.success {
            background: var(--success-color);
        }
        
        button.success:hover {
            background: #27ae60;
        }
        
        button.warning {
            background: var(--warning-color);
        }
        
        button.warning:hover {
            background: #d35400;
        }
        
        button.danger {
            background: var(--danger-color);
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        .status-panel {
            grid-column: 1 / -1;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-label {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .history-panel {
            grid-column: 1 / -1;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-time {
            opacity: 0.7;
        }
        
        .history-action {
            font-weight: 500;
        }
        
        .history-value {
            color: var(--primary-color);
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
            }
        }
        
        .light-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .light-preview {
            height: 40px;
            border-radius: 5px;
            margin-top: 10px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            transition: all 0.5s ease;
        }
        
        .advanced-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .color-palette {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .color-option.active {
            border-color: white;
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>矩阵球控制系统</h1>
            <p class="subtitle">精确控制矩阵球的升降与动态灯光颜色变化</p>
        </header>
        
        <div class="dashboard">
            <div class="panel">
                <h2 class="panel-title">3D 可视化</h2>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap;">
                    <button id="btnBallZoomIn" style="padding: 6px 12px; font-size: 1rem;">球体放大</button>
                    <button id="btnBallZoomOut" style="padding: 6px 12px; font-size: 1rem;">球体缩小</button>
                    <span id="ballZoomLabel" style="font-size: 1rem; color: var(--primary-color);">100%</span>
                    <button id="btnViewTop" style="padding: 6px 12px; font-size: 1rem;">顶部视角</button>
                    <button id="btnViewSide" style="padding: 6px 12px; font-size: 1rem;">侧面视角</button>
                    <button id="btnViewOblique" style="padding: 6px 12px; font-size: 1rem;">斜视视角</button>
                </div>
                <div class="visualization" id="visualization3d">
                    <div class="matrix-container" id="matrixContainer">
                        <div class="matrix-grid" id="matrixGrid">
                            <!-- 矩阵球将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title">控制面板</h2>
                <div class="controls">
                    <div class="control-group">
                        <label for="heightControl">高度控制</label>
                        <input type="range" id="heightControl" min="0" max="150" value="50">
                        <div class="value-display" id="heightValue">50</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="speedControl">速度控制</label>
                        <input type="range" id="speedControl" min="1" max="10" value="5">
                        <div class="value-display" id="speedValue">5</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="patternControl">升降模式</label>
                        <select id="patternControl" style="width: 100%; padding: 10px; border-radius: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">
                            <option value="uniform">统一升降</option>
                            <option value="wave">波浪模式</option>
                            <option value="random">随机模式</option>
                            <option value="spiral">螺旋模式</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="matrixSize">矩阵尺寸</label>
                        <select id="matrixSize" style="width: 100%; padding: 10px; border-radius: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">
                            <option value="4">4x4</option>
                            <option value="8">8x8</option>
                            <option value="16">16x16</option>
                            <option value="32">32x32</option>
                            <option value="64">64x64</option>
                            <option value="100">100x100</option>
                            <option value="6x28">6x28</option>
                            <option value="12x56">12x56</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="panel-title" style="margin-top: 20px;">灯光控制</h2>
                <div class="light-controls">
                    <div class="control-group">
                        <label for="lightMode">灯光模式</label>
                        <select id="lightMode" style="width: 100%; padding: 10px; border-radius: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">
                            <option value="single">单色模式</option>
                            <option value="rainbow">彩虹模式</option>
                            <option value="pulse">脉冲模式</option>
                            <option value="gradient">渐变模式</option>
                            <option value="breathe">呼吸灯模式</option>
                            <option value="scan">扫描模式</option>
                            <option value="chase">追逐模式</option>
                            <option value="fire">火焰效果</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="lightColor">主色调</label>
                        <input type="color" id="lightColor" value="#3498db" style="width: 100%; height: 40px; border: none; border-radius: 5px; background: rgba(255,255,255,0.1);">
                    </div>
                </div>
                
                <div class="advanced-controls">
                    <label>快速颜色选择</label>
                    <div class="color-palette">
                        <div class="color-option active" style="background-color: #3498db;" data-color="#3498db"></div>
                        <div class="color-option" style="background-color: #2ecc71;" data-color="#2ecc71"></div>
                        <div class="color-option" style="background-color: #e74c3c;" data-color="#e74c3c"></div>
                        <div class="color-option" style="background-color: #f39c12;" data-color="#f39c12"></div>
                        <div class="color-option" style="background-color: #9b59b6;" data-color="#9b59b6"></div>
                        <div class="color-option" style="background-color: #1abc9c;" data-color="#1abc9c"></div>
                    </div>
                </div>
                
                <div class="light-preview" id="lightPreview"></div>
                
                <div class="button-group">
                    <button id="btnRaise" class="success">上升</button>
                    <button id="btnLower" class="warning">下降</button>
                    <button id="btnStop" class="danger">停止</button>
                    <button id="btnReset">重置</button>
                    
                </div>
            
                <button id="btnWaveMode" style="width: 100%; padding: 10px; border-radius: 5px; background: #2980b9; color: white; font-weight: bold; border: none; margin-top: 8px;">波浪模式</button>
            
                <div class="control-group" style="margin-top: 15px;">
                    <label for="waveType">波浪类型</label>
                    <select id="waveType" style="width: 100%; margin-top: 6px; padding: 8px; border-radius: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">
                        <option value="diagonal">对角波浪</option>
                        <option value="row">前后波浪</option>
                        <option value="col">左右波浪</option>
                    </select>
                </div>
            </div>
            
            <div class="panel status-panel">
                <h2 class="panel-title">系统状态</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">当前高度</div>
                        <div class="status-value" id="currentHeight">50%</div>
                        <div class="status-label">目标高度: <span id="targetHeight">50%</span></div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">运行状态</div>
                        <div class="status-value" id="operationStatus">待机</div>
                        <div class="status-label">模式: <span id="currentMode">统一升降</span></div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">灯光状态</div>
                        <div class="status-value" id="lightStatus">单色模式</div>
                        <div class="status-label">颜色: <span id="currentColor">#3498db</span></div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">系统状态</div>
                        <div class="status-value" id="systemStatus">正常</div>
                        <div class="status-label">最后更新: <span id="lastUpdate">刚刚</span></div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">当前速度</div>
                        <div class="status-value" id="currentSpeed">5</div>
                        <div class="status-label">矩阵尺寸: <span id="currentSize">4x4</span></div>
                    </div>
                </div>
            </div>
            
            <div class="panel history-panel">
                <h2 class="panel-title">操作历史</h2>
                <div class="history-list" id="historyList">
                    <!-- 历史记录将通过JS动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 3D窗口缩放相关变量
        // 球体缩放相关变量
        let ballZoomScale = 1.0;
        const minBallZoom = 0.3;
        const maxBallZoom = 2.5;
        function updateBallZoomDisplay() {
            document.getElementById('ballZoomLabel').textContent = Math.round(ballZoomScale * 100) + '%';
        }
        function applyBallZoom(size) {
            // 动态调整所有球体大小
            const cells = document.querySelectorAll('.matrix-cell');
            let baseSize = 40;
            if (size > 32) {
                baseSize = Math.max(6, 300 / size);
            } else if (size > 16) {
                baseSize = 12;
            } else if (size > 8) {
                baseSize = 20;
            }
            const newSize = baseSize * ballZoomScale;
            cells.forEach(cell => {
                cell.style.width = `${newSize}px`;
                cell.style.height = `${newSize}px`;
            });
        }
        // 全局变量
        let animationFrameId;
        let animationTime = 0;
        let scanPosition = 0;
        let chasePosition = 0;
        
        // 初始化矩阵球
        function initializeMatrix(size) {
            const matrixGrid = document.getElementById('matrixGrid');
            matrixGrid.innerHTML = '';
            let rows = size, cols = size;
            if (typeof size === 'string' && size.includes('x')) {
                const arr = size.split('x');
                rows = parseInt(arr[0]);
                cols = parseInt(arr[1]);
            }
            matrixGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            // 动态调整球体大小和间距，保证可视化窗口适配
            let cellSize = 40;
            let gridGap = 20;
            const maxDim = Math.max(rows, cols);
            if (maxDim > 32) {
                cellSize = Math.max(6, 300 / maxDim);
                gridGap = Math.max(2, 8 - Math.floor(maxDim/20));
            } else if (maxDim > 16) {
                cellSize = 12;
                gridGap = 6;
            } else if (maxDim > 8) {
                cellSize = 20;
                gridGap = 10;
            }
            matrixGrid.style.gridGap = `${gridGap}px`;
                        for (let i = 0; i < rows * cols; i++) {
                                const cell = document.createElement('div');
                                cell.className = 'matrix-cell';
                                cell.textContent = '';
                                cell.style.width = `${cellSize * ballZoomScale}px`;
                                cell.style.height = `${cellSize * ballZoomScale}px`;
                                matrixGrid.appendChild(cell);
                        }
            // 更新当前尺寸显示
            document.getElementById('currentSize').textContent = `${rows}x${cols}`;
        }
        
        // 更新矩阵球高度和灯光
        function updateMatrixHeight(height, pattern, lightMode, lightColor) {

            const cells = document.querySelectorAll('.matrix-cell');
            const size = Math.sqrt(cells.length);
            let maxOffset = 80;
            if (size > 32) {
                maxOffset = 12;
            } else if (size > 16) {
                maxOffset = 24;
            } else if (size > 8) {
                maxOffset = 40;
            }
            // 波浪模式优化：动画帧驱动，无延迟，实时高度变化
            if (pattern === 'wave') {
                // 波浪模式不与升降高度联动，中心高度固定为75
                const waveCenter = 75;
                cells.forEach((cell, index) => {
                    const row = Math.floor(index / size);
                    const col = index % size;
                    let phase = 0;
                    if (waveType === 'diagonal') {
                        phase = (row + col) / size * Math.PI;
                    } else if (waveType === 'row') {
                        phase = row / size * Math.PI;
                    } else if (waveType === 'col') {
                        phase = col / size * Math.PI;
                    }
                    let cellHeight = waveCenter + 50 * Math.sin(phase + animationTime * 2);
                    let zBase = 40;
                    let zRange = 40;
                    let zOffset = zBase + Math.max(0, Math.min(zRange, cellHeight * zRange/100));
                    cell.style.transform = `translateZ(${zOffset}px)`;
                    applyLightEffect(cell, index, cellHeight, lightMode, lightColor, size);
                    if (cellHeight > 30) {
                        cell.classList.add('active');
                    } else {
                        cell.classList.remove('active');
                    }
                });
            } else {
                cells.forEach((cell, index) => {
                    let delay = 0;
                    const row = Math.floor(index / size);
                    const col = index % size;
                    switch(pattern) {
                        case 'random':
                            delay = Math.random() * 0.3;
                            break;
                        case 'spiral':
                            const center = (size - 1) / 2;
                            const distance = Math.sqrt(Math.pow(row - center, 2) + Math.pow(col - center, 2));
                            delay = distance * 0.08;
                            break;
                        default:
                            delay = 0;
                    }
                    let cellHeight = height;
                    if (pattern === 'random') {
                        cellHeight = height + (Math.random() - 0.5) * 30;
                    } else if (pattern === 'spiral') {
                        cellHeight = height + 20 * Math.sin(distance + height/25);
                    }
                    setTimeout(() => {
                        let zBase = 40;
                        let zRange = 40;
                        let zOffset = zBase + Math.max(0, Math.min(zRange, cellHeight * zRange/100));
                        cell.style.transform = `translateZ(${zOffset}px)`;
                        applyLightEffect(cell, index, cellHeight, lightMode, lightColor, size);
                        if (cellHeight > 30) {
                            cell.classList.add('active');
                        } else {
                            cell.classList.remove('active');
                        }
                    }, delay * 1000);
                });
            }
        }
        
        // 应用灯光效果
        function applyLightEffect(cell, index, height, lightMode, lightColor, size) {
            const row = Math.floor(index / size);
            const col = index % size;
            // 波浪模式下灯光与高度联动
            if (document.getElementById('patternControl').value === 'wave') {
                // 彩虹灯光：色相与波浪高度和动画时间联动
                const hue = (row * 30 + col * 10 + height * 2 + animationTime * 30) % 360;
                cell.style.backgroundColor = `hsl(${hue}, 100%, 60%)`;
                cell.style.boxShadow = `0 0 8px hsl(${hue}, 100%, 60%)`;
                return;
            }
            switch(lightMode) {
                case 'rainbow':
                    // 彩虹效果 - 基于位置和高度
                    const hue = (row * 30 + col * 10 + height * 2 + animationTime * 10) % 360;
                    cell.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
                    cell.style.boxShadow = `0 0 6px hsl(${hue}, 100%, 50%)`;
                    break;
                case 'pulse':
                    // 脉冲效果 - 基于时间
                    const pulseIntensity = 0.5 + 0.5 * Math.sin(animationTime * 5 + index * 0.2);
                    const r = parseInt(lightColor.substr(1, 2), 16);
                    const g = parseInt(lightColor.substr(3, 2), 16);
                    const b = parseInt(lightColor.substr(5, 2), 16);
                    cell.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${pulseIntensity})`;
                    cell.style.boxShadow = `0 0 ${4 + pulseIntensity * 6}px rgba(${r}, ${g}, ${b}, ${pulseIntensity})`;
                    break;
                case 'gradient':
                    // 渐变效果 - 基于高度
                    const intensity = height / 100;
                    const r2 = parseInt(lightColor.substr(1, 2), 16);
                    const g2 = parseInt(lightColor.substr(3, 2), 16);
                    const b2 = parseInt(lightColor.substr(5, 2), 16);
                    cell.style.backgroundColor = `rgba(${r2}, ${g2}, ${b2}, ${intensity})`;
                    cell.style.boxShadow = `0 0 ${2 + intensity * 5}px rgba(${r2}, ${g2}, ${b2}, ${intensity})`;
                    break;
                case 'breathe':
                    // 呼吸灯效果
                    const breatheIntensity = 0.3 + 0.7 * Math.sin(animationTime * 3);
                    const r3 = parseInt(lightColor.substr(1, 2), 16);
                    const g3 = parseInt(lightColor.substr(3, 2), 16);
                    const b3 = parseInt(lightColor.substr(5, 2), 16);
                    cell.style.backgroundColor = `rgba(${r3}, ${g3}, ${b3}, ${breatheIntensity})`;
                    cell.style.boxShadow = `0 0 ${2 + breatheIntensity * 8}px rgba(${r3}, ${g3}, ${b3}, ${breatheIntensity})`;
                    break;
                case 'scan':
                    // 扫描效果
                    const scanValue = Math.abs((row + col) - scanPosition) / (size * 2);
                    const scanIntensity = Math.max(0, 1 - scanValue * 2);
                    const r4 = parseInt(lightColor.substr(1, 2), 16);
                    const g4 = parseInt(lightColor.substr(3, 2), 16);
                    const b4 = parseInt(lightColor.substr(5, 2), 16);
                    cell.style.backgroundColor = `rgba(${r4}, ${g4}, ${b4}, ${scanIntensity})`;
                    cell.style.boxShadow = `0 0 ${2 + scanIntensity * 6}px rgba(${r4}, ${g4}, ${b4}, ${scanIntensity})`;
                    break;
                case 'chase':
                    // 追逐效果
                    const chaseValue = (row + col + chasePosition) % 8;
                    const chaseIntensity = chaseValue < 4 ? 1 : 0.2;
                    const r5 = parseInt(lightColor.substr(1, 2), 16);
                    const g5 = parseInt(lightColor.substr(3, 2), 16);
                    const b5 = parseInt(lightColor.substr(5, 2), 16);
                    cell.style.backgroundColor = `rgba(${r5}, ${g5}, ${b5}, ${chaseIntensity})`;
                    cell.style.boxShadow = `0 0 ${2 + chaseIntensity * 6}px rgba(${r5}, ${g5}, ${b5}, ${chaseIntensity})`;
                    break;
                case 'fire':
                    // 火焰效果
                    const fireIntensity = 0.3 + 0.7 * Math.random();
                    const fireHue = 15 + Math.random() * 20;
                    const fireSaturation = 80 + Math.random() * 20;
                    cell.style.backgroundColor = `hsl(${fireHue}, ${fireSaturation}%, ${50 * fireIntensity}%)`;
                    cell.style.boxShadow = `0 0 ${2 + fireIntensity * 8}px hsl(${fireHue}, ${fireSaturation}%, ${50 * fireIntensity}%)`;
                    break;
                default: // single
                    // 单色模式
                    cell.style.backgroundColor = lightColor;
                    cell.style.boxShadow = `0 0 6px ${lightColor}`;
                    break;
            }
        }
        
        // 更新灯光预览
        function updateLightPreview(lightMode, lightColor) {
            const preview = document.getElementById('lightPreview');
            
            switch(lightMode) {
                case 'rainbow':
                    preview.style.background = 'linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet)';
                    preview.style.boxShadow = '0 0 15px rgba(255, 0, 0, 0.5)';
                    preview.style.animation = 'none';
                    break;
                    
                case 'pulse':
                    preview.style.background = lightColor;
                    preview.style.animation = 'pulse 2s infinite';
                    break;
                    
                case 'gradient':
                    const r = parseInt(lightColor.substr(1, 2), 16);
                    const g = parseInt(lightColor.substr(3, 2), 16);
                    const b = parseInt(lightColor.substr(5, 2), 16);
                    preview.style.background = `linear-gradient(90deg, rgba(${r}, ${g}, ${b}, 0.3), ${lightColor})`;
                    preview.style.boxShadow = `0 0 15px ${lightColor}`;
                    preview.style.animation = 'none';
                    break;
                    
                case 'breathe':
                    preview.style.background = lightColor;
                    preview.style.animation = 'pulse 3s infinite';
                    break;
                    
                case 'scan':
                    preview.style.background = `linear-gradient(90deg, transparent, ${lightColor}, transparent)`;
                    preview.style.boxShadow = `0 0 15px ${lightColor}`;
                    preview.style.animation = 'none';
                    break;
                    
                case 'chase':
                    preview.style.background = `repeating-linear-gradient(90deg, ${lightColor}, ${lightColor} 10px, transparent 10px, transparent 20px)`;
                    preview.style.boxShadow = `0 0 15px ${lightColor}`;
                    preview.style.animation = 'none';
                    break;
                    
                case 'fire':
                    preview.style.background = 'linear-gradient(90deg, #ff0000, #ff9900, #ffff00)';
                    preview.style.boxShadow = '0 0 15px rgba(255, 0, 0, 0.5)';
                    preview.style.animation = 'none';
                    break;
                    
                default: // single
                    preview.style.background = lightColor;
                    preview.style.boxShadow = `0 0 15px ${lightColor}`;
                    preview.style.animation = 'none';
                    break;
            }
        }
        
        // 动画循环
        function animate() {
            animationTime += 0.05;
            scanPosition = (scanPosition + 0.1) % 8;
            chasePosition = (chasePosition + 0.2) % 8;
            const lightMode = document.getElementById('lightMode').value;
            const lightColor = document.getElementById('lightColor').value;
            const height = document.getElementById('heightControl').value;
            const pattern = document.getElementById('patternControl').value;
            if (isMeteorMode) {
                runMeteorRain();
            } else if (typeof isWaveMode !== 'undefined' && isWaveMode) {
                updateMatrixHeight(0, 'wave', lightMode, lightColor);
            } else if (["rainbow", "pulse", "breathe", "scan", "chase", "fire"].includes(lightMode)) {
                updateMatrixHeight(height, pattern, lightMode, lightColor);
            }
            animationFrameId = requestAnimationFrame(animate);
        }
        
        // 添加历史记录
        function addHistory(action, value) {
            const historyList = document.getElementById('historyList');
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            historyItem.innerHTML = `
                <span class="history-time">${timeString}</span>
                <span class="history-action">${action}</span>
                <span class="history-value">${value}</span>
            `;
            
            historyList.insertBefore(historyItem, historyList.firstChild);
            
            // 限制历史记录数量
            if (historyList.children.length > 10) {
                historyList.removeChild(historyList.lastChild);
            }
        }
        
        // 更新状态显示
        function updateStatus(height, speed, mode, lightMode, status) {
            document.getElementById('currentHeight').textContent = height;
            document.getElementById('targetHeight').textContent = height;
            document.getElementById('currentSpeed').textContent = speed;
            document.getElementById('currentMode').textContent = 
                document.getElementById('patternControl').options[document.getElementById('patternControl').selectedIndex].text;
            document.getElementById('lightStatus').textContent = 
                document.getElementById('lightMode').options[document.getElementById('lightMode').selectedIndex].text;
            document.getElementById('currentColor').textContent = document.getElementById('lightColor').value;
            document.getElementById('operationStatus').textContent = status;
            
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 视角切换按钮事件
            const matrixGrid = document.getElementById('matrixGrid');
            document.getElementById('btnViewTop').addEventListener('click', function() {
                matrixGrid.style.transform = 'rotateX(90deg)';
            });
            document.getElementById('btnViewSide').addEventListener('click', function() {
                matrixGrid.style.transform = 'none';
            });
            document.getElementById('btnViewOblique').addEventListener('click', function() {
                matrixGrid.style.transform = 'rotateX(60deg) rotateZ(45deg)';
            });
            // 默认斜视视角
            matrixGrid.style.transform = 'rotateX(60deg) rotateZ(45deg)';
            // 球体缩放按钮事件
            document.getElementById('btnBallZoomIn').addEventListener('click', function() {
                ballZoomScale = Math.min(maxBallZoom, ballZoomScale + 0.1);
                const size = Math.sqrt(document.querySelectorAll('.matrix-cell').length);
                applyBallZoom(size);
                updateBallZoomDisplay();
            });
            document.getElementById('btnBallZoomOut').addEventListener('click', function() {
                ballZoomScale = Math.max(minBallZoom, ballZoomScale - 0.1);
                const size = Math.sqrt(document.querySelectorAll('.matrix-cell').length);
                applyBallZoom(size);
                updateBallZoomDisplay();
            });
            // 初始化球体缩放显示
            updateBallZoomDisplay();
            // 初始化矩阵
            initializeMatrix(4);

            
            // 开始动画循环
            animate();
            
            // 设置滑块事件监听
            const heightControl = document.getElementById('heightControl');
            const heightValue = document.getElementById('heightValue');
            
            // 高度滑块事件
            heightControl.addEventListener('input', function() {
                const value = this.value;
                heightValue.textContent = value;
                document.getElementById('targetHeight').textContent = value;
                
                const pattern = document.getElementById('patternControl').value;
                const lightMode = document.getElementById('lightMode').value;
                const lightColor = document.getElementById('lightColor').value;
                
                updateMatrixHeight(value, pattern, lightMode, lightColor);
                
                updateStatus(value, 
                    document.getElementById('speedControl').value, 
                    document.getElementById('patternControl').value,
                    document.getElementById('lightMode').value,
                    '手动控制');
                
                addHistory('高度调整', `${value}%`);
            });
            
            // 速度控制
            const speedControl = document.getElementById('speedControl');
            const speedValue = document.getElementById('speedValue');
            
            speedControl.addEventListener('input', function() {
                const value = this.value;
                speedValue.textContent = value;
                updateStatus(
                    document.getElementById('heightControl').value,
                    value,
                    document.getElementById('patternControl').value,
                    document.getElementById('lightMode').value,
                    '速度调整'
                );
                addHistory('速度调整', value);
            });
            
            // 模式选择
            const patternControl = document.getElementById('patternControl');
            patternControl.addEventListener('change', function() {
                const pattern = this.value;
                const height = document.getElementById('heightControl').value;
                const lightMode = document.getElementById('lightMode').value;
                const lightColor = document.getElementById('lightColor').value;
                
                updateMatrixHeight(height, pattern, lightMode, lightColor);
                updateStatus(
                    height,
                    document.getElementById('speedControl').value,
                    pattern,
                    lightMode,
                    '模式切换'
                );
                addHistory('模式切换', this.options[this.selectedIndex].text);
            });
            
            // 矩阵尺寸
            const matrixSize = document.getElementById('matrixSize');
            matrixSize.addEventListener('change', function() {
                let size = this.value;
                if (!isNaN(parseInt(size)) && !size.includes('x')) {
                    size = parseInt(size);
                }
                initializeMatrix(size);
                let rows = size, cols = size;
                if (typeof size === 'string' && size.includes('x')) {
                    const arr = size.split('x');
                    rows = parseInt(arr[0]);
                    cols = parseInt(arr[1]);
                }
                applyBallZoom(Math.max(rows, cols));
            // 每次高度变化时也同步球体缩放
            applyBallZoom(size);
                
                const height = document.getElementById('heightControl').value;
                const pattern = document.getElementById('patternControl').value;
                const lightMode = document.getElementById('lightMode').value;
                const lightColor = document.getElementById('lightColor').value;
                
                updateMatrixHeight(height, pattern, lightMode, lightColor);
                updateStatus(
                    height,
                    document.getElementById('speedControl').value,
                    pattern,
                    lightMode,
                    '矩阵重置'
                );
                addHistory('矩阵重置', `${size}x${size}`);
            });
            
            // 灯光模式
            const lightMode = document.getElementById('lightMode');
            lightMode.addEventListener('change', function() {
                const mode = this.value;
                const height = document.getElementById('heightControl').value;
                const pattern = document.getElementById('patternControl').value;
                const lightColor = document.getElementById('lightColor').value;
                
                updateMatrixHeight(height, pattern, mode, lightColor);
                updateLightPreview(mode, lightColor);
                updateStatus(
                    height,
                    document.getElementById('speedControl').value,
                    pattern,
                    mode,
                    '灯光切换'
                );
                addHistory('灯光切换', this.options[this.selectedIndex].text);
            });
            
            // 灯光颜色
            const lightColor = document.getElementById('lightColor');
            lightColor.addEventListener('input', function() {
                const color = this.value;
                const height = document.getElementById('heightControl').value;
                const pattern = document.getElementById('patternControl').value;
                const lightMode = document.getElementById('lightMode').value;
                
                updateMatrixHeight(height, pattern, lightMode, color);
                updateLightPreview(lightMode, color);
                updateStatus(
                    height,
                    document.getElementById('speedControl').value,
                    pattern,
                    lightMode,
                    '颜色调整'
                );
                addHistory('颜色调整', color);
                
                // 更新快速颜色选择器的活动状态
                document.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.color === color) {
                        option.classList.add('active');
                    }
                });
            });
            
            // 快速颜色选择
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const color = this.dataset.color;
                    lightColor.value = color;
                    
                    // 更新活动状态
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 触发颜色变化
                    const event = new Event('input');
                    lightColor.dispatchEvent(event);
                });
            });
            
            // 按钮事件
            document.getElementById('btnRaise').addEventListener('click', function() {
                const currentHeight = parseInt(heightControl.value);
                const newHeight = Math.min(150, currentHeight + 10);
                heightControl.value = newHeight;
                heightValue.textContent = newHeight;
                
                const pattern = document.getElementById('patternControl').value;
                const lightMode = document.getElementById('lightMode').value;
                const lightColor = document.getElementById('lightColor').value;
                
                updateMatrixHeight(newHeight, pattern, lightMode, lightColor);
                // 灯光预览也刷新
                updateLightPreview(lightMode, lightColor);
                updateStatus(newHeight, 
                    document.getElementById('speedControl').value, 
                    document.getElementById('patternControl').value,
                    document.getElementById('lightMode').value,
                    '上升中');
                addHistory('上升操作', `${newHeight}%`);
            });
            
            document.getElementById('btnLower').addEventListener('click', function() {
                const currentHeight = parseInt(heightControl.value);
                const newHeight = Math.max(0, currentHeight - 10);
                heightControl.value = newHeight;
                heightValue.textContent = newHeight;
                
                const pattern = document.getElementById('patternControl').value;
                const lightMode = document.getElementById('lightMode').value;
                const lightColor = document.getElementById('lightColor').value;
                
                updateMatrixHeight(newHeight, pattern, lightMode, lightColor);
                updateLightPreview(lightMode, lightColor);
                updateStatus(newHeight, 
                    document.getElementById('speedControl').value, 
                    document.getElementById('patternControl').value,
                    document.getElementById('lightMode').value,
                    '下降中');
                addHistory('下降操作', `${newHeight}%`);
            });
            
            

            document.getElementById('btnStop').addEventListener('click', function() {
                updateStatus(
                    document.getElementById('heightControl').value,
                    document.getElementById('speedControl').value,
                    document.getElementById('patternControl').value,
                    document.getElementById('lightMode').value,
                    '已停止'
                );
                addHistory('停止操作', '系统暂停');
            });
            
            document.getElementById('btnReset').addEventListener('click', function() {
                heightControl.value = 50;
                heightValue.textContent = '50';
                speedControl.value = 5;
                speedValue.textContent = '5';
                patternControl.value = 'uniform';
                lightMode.value = 'single';
                lightColor.value = '#3498db';
                
                // 更新快速颜色选择器
                document.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.color === '#3498db') {
                        option.classList.add('active');
                    }
                });
                
                updateMatrixHeight(50, 'uniform', 'single', '#3498db');
                updateLightPreview('single', '#3498db');
                updateStatus(50, 5, 'uniform', 'single', '已重置');
                addHistory('系统重置', '恢复默认设置');
            });
            
            // 初始状态
            updateStatus(50, 5, 'uniform', 'single', '待机');
            updateLightPreview('single', '#3498db');
            addHistory('系统启动', '初始化完成');
            
            // 添加一些初始历史记录
            addHistory('模式测试', '波浪模式');
            addHistory('灯光测试', '彩虹模式');
            addHistory('高度调整', '30%');
            addHistory('速度调整', '7');
        });
        
        let isWaveMode = false;
        document.getElementById('btnWaveMode').addEventListener('click', function() {
            isWaveMode = !isWaveMode;
            if (isWaveMode) {
                this.style.background = '#27ae60';
                this.textContent = '退出波浪模式';
            } else {
                this.style.background = '#2980b9';
                this.textContent = '波浪模式';
            }
        });
        
        let waveType = 'diagonal';
        document.getElementById('waveType').addEventListener('change', function() {
            waveType = this.value;
        });
        
        let isMeteorMode = false;
        let meteorList = [];
        document.getElementById('btnMeteor').addEventListener('click', function() {
            isMeteorMode = !isMeteorMode;
            if (isMeteorMode) {
                this.style.background = '#d35400';
                this.textContent = '退出流星雨';
                meteorList = [];
            } else {
                this.style.background = '#e67e22';
                this.textContent = '流星雨';
            }
        });
        
        function runMeteorRain() {
            // 已取消流星雨效果，恢复为静态显示
            const cells = document.querySelectorAll('.matrix-cell');
            cells.forEach(cell => {
                cell.style.transform = 'translateZ(0px)';
                cell.style.backgroundColor = '';
                cell.style.boxShadow = '';
                cell.style.opacity = 1;
            });
            meteorList = [];
        }
    </script>
</body>
</html>